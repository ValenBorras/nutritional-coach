# üîî Push Notifications Setup - NutriGuide PWA

## ¬øQu√© son las notificaciones push?

Las notificaciones push son mensajes que se pueden enviar a los usuarios incluso cuando no est√°n usando activamente tu aplicaci√≥n. Son especialmente √∫tiles para recordatorios, actualizaciones importantes y mantener el engagement de los usuarios.

## ‚úÖ Implementaci√≥n Completada

### üîß Componentes Implementados

1. **Hook personalizado** (`hooks/use-push-notifications.ts`)
   - Manejo de permisos de notificaci√≥n
   - Suscripci√≥n/cancelaci√≥n autom√°tica
   - Detecci√≥n de soporte del navegador
   - Manejo de errores y estados

2. **Componente UI** (`app/components/push-notifications-manager.tsx`)
   - Interface intuitiva para gestionar notificaciones
   - Toggle para activar/desactivar
   - Bot√≥n de prueba
   - Indicadores de estado visual
   - Instrucciones para permisos bloqueados

3. **APIs del backend**
   - `POST /api/push/subscribe` - Crear/actualizar suscripci√≥n
   - `POST /api/push/unsubscribe` - Cancelar suscripci√≥n
   - `POST /api/push/test` - Enviar notificaci√≥n de prueba

4. **Base de datos**
   - Tabla `push_subscriptions` con RLS policies
   - Almacenamiento seguro de claves de suscripci√≥n
   - Tracking de suscripciones activas/inactivas

5. **Service Worker mejorado**
   - Manejo avanzado de notificaciones
   - Soporte para acciones en notificaciones
   - Navegaci√≥n inteligente al hacer click

### üîë VAPID Keys Configuradas

**‚ö†Ô∏è IMPORTANTE - Variables de Entorno:**
Las claves VAPID ahora se configuran usando variables de entorno para mayor seguridad.

**Agrega estas variables a tu archivo `.env.local`:**

```env
# VAPID Keys para Push Notifications
VAPID_PUBLIC_KEY=BPdK3I5-SWo15agKaIqHvNHr1mPy1DZ6XPzCmpktM1N7JYB4kjUDcV3-Xd3mGtxRf6LKR81cGce-RIYEMQctHxc
VAPID_PRIVATE_KEY=VLPz4mVqTWytL0HCTSl1rBEWRd2rQmOpgAYKCoEcCw4
VAPID_EMAIL=tu-email@ejemplo.com

# Variable p√∫blica para el frontend (debe empezar con NEXT_PUBLIC_)
NEXT_PUBLIC_VAPID_PUBLIC_KEY=BPdK3I5-SWo15agKaIqHvNHr1mPy1DZ6XPzCmpktM1N7JYB4kjUDcV3-Xd3mGtxRf6LKR81cGce-RIYEMQctHxc
```

**‚ö†Ô∏è Seguridad:**
- ‚úÖ Las claves privadas est√°n protegidas en variables de entorno
- ‚úÖ Solo la clave p√∫blica se expone al frontend (con NEXT_PUBLIC_)
- ‚úÖ Las claves no est√°n hardcodeadas en el c√≥digo
- ‚úÖ Seguro para hacer commit y desplegar

## üöÄ Configuraci√≥n Inicial

### 1. Configurar variables de entorno

**OBLIGATORIO:** Agrega estas variables a tu archivo `.env.local`:

```env
# VAPID Keys para Push Notifications
VAPID_PUBLIC_KEY=BPdK3I5-SWo15agKaIqHvNHr1mPy1DZ6XPzCmpktM1N7JYB4kjUDcV3-Xd3mGtxRf6LKR81cGce-RIYEMQctHxc
VAPID_PRIVATE_KEY=VLPz4mVqTWytL0HCTSl1rBEWRd2rQmOpgAYKCoEcCw4
VAPID_EMAIL=tu-email@ejemplo.com

# Variable p√∫blica para el frontend (debe empezar con NEXT_PUBLIC_)
NEXT_PUBLIC_VAPID_PUBLIC_KEY=BPdK3I5-SWo15agKaIqHvNHr1mPy1DZ6XPzCmpktM1N7JYB4kjUDcV3-Xd3mGtxRf6LKR81cGce-RIYEMQctHxc
```

### 2. Crear la tabla en Supabase

Ejecuta el script SQL en tu panel de Supabase:

```sql
-- Ejecutar: create_push_subscriptions_table.sql
```

### 3. Verificar dependencias

```bash
npm install web-push @radix-ui/react-switch
npm i --save-dev @types/web-push
```

## üîß Service Worker Autom√°tico Mejorado

### ‚úÖ Nuevo sistema robusto

El sistema ahora incluye registro autom√°tico del service worker que:

- **Se registra inmediatamente** al cargar la aplicaci√≥n
- **M√∫ltiples reintentos** espec√≠ficos para Safari
- **Detecci√≥n autom√°tica** de estado de registraci√≥n
- **Verificaci√≥n de archivos** antes del registro
- **Timeouts configurables** para diferentes navegadores
- **Logging detallado** para debugging
- **Eventos customizados** para comunicaci√≥n entre componentes

### üçé Mejoras espec√≠ficas para Safari

1. **Registro progresivo**: Hasta 3 intentos de registro con delays incrementales
2. **Verificaci√≥n de archivos**: Comprueba que `/sw.js` sea accesible antes de registrar
3. **Timeouts adaptativos**: M√°s tiempo para Safari (15 segundos vs 10)
4. **M√∫ltiples estrategias**: Diferentes opciones de registro si la primera falla
5. **Detecci√≥n de modo PWA**: Mensajes espec√≠ficos seg√∫n el contexto

### üöÄ C√≥mo funciona autom√°ticamente

```typescript
// El sistema autom√°ticamente:
1. Verifica soporte del navegador
2. Comprueba accesibilidad del archivo SW
3. Busca registraciones existentes
4. Registra el SW si es necesario
5. Espera a que est√© listo con timeout
6. Notifica a otros componentes
7. Reintenta si es Safari y fall√≥
```

## üì± C√≥mo usar las notificaciones

### Para usuarios finales

1. **Activar notificaciones:**
   - Ve a Dashboard ‚Üí Configuraciones
   - Busca la secci√≥n "Notificaciones Push"
   - Activa el toggle "Activar notificaciones"
   - Acepta los permisos cuando aparezca el popup

2. **Probar funcionamiento:**
   - Usa el bot√≥n "Enviar notificaci√≥n de prueba"
   - Verifica que llegue la notificaci√≥n al dispositivo

3. **Gestionar permisos:**
   - Si los permisos est√°n bloqueados, sigue las instrucciones en pantalla
   - En Chrome: Click en el candado ‚Üí Notificaciones ‚Üí Permitir
   - En Safari: Configuraci√≥n ‚Üí Notificaciones ‚Üí Permitir

### Para desarrolladores

```typescript
// Usar el hook en cualquier componente
const {
  isSupported,
  isSubscribed,
  permission,
  subscribe,
  unsubscribe,
  sendTestNotification
} = usePushNotifications()

// Verificar si est√°n soportadas
if (isSupported) {
  // Suscribirse
  await subscribe()
  
  // Enviar prueba
  await sendTestNotification()
  
  // Cancelar suscripci√≥n
  await unsubscribe()
}
```

## üéØ Tipos de notificaciones configuradas

### Notificaci√≥n de prueba
- **T√≠tulo:** "üçé NutriGuide - Notificaci√≥n de prueba"
- **Cuerpo:** Personalizado con nombre del usuario
- **Acciones:** "Abrir App" y "Cerrar"
- **Vibraci√≥n:** Patr√≥n personalizado

### Estructura de payload
```json
{
  "title": "üçé NutriGuide - T√≠tulo",
  "body": "Mensaje personalizado",
  "icon": "/icons/icon-192x192.png",
  "badge": "/icons/icon-72x72.png",
  "image": "/icons/icon-384x384.png",
  "data": {
    "url": "/dashboard",
    "timestamp": 1234567890,
    "type": "reminder"
  },
  "actions": [
    {
      "action": "open",
      "title": "Abrir App",
      "icon": "/icons/icon-96x96.png"
    },
    {
      "action": "dismiss",
      "title": "Cerrar",
      "icon": "/icons/icon-72x72.png"
    }
  ],
  "tag": "notification-type",
  "vibrate": [200, 100, 200]
}
```

## üîß Funcionalidades Avanzadas

### 1. Env√≠o de notificaciones personalizadas

```typescript
// API para enviar notificaciones custom
POST /api/push/send
{
  "userIds": ["user-id-1", "user-id-2"],
  "title": "Recordatorio personalizado",
  "body": "Es hora de registrar tu comida",
  "data": {
    "url": "/dashboard/food-log",
    "type": "meal-reminder"
  }
}
```

### 2. Programaci√≥n de recordatorios

```typescript
// Programar recordatorios autom√°ticos
POST /api/push/schedule
{
  "userId": "user-id",
  "schedule": "daily",
  "time": "08:00",
  "title": "Recordatorio matutino",
  "body": "¬°Buenos d√≠as! ¬øQu√© vas a desayunar hoy?"
}
```

### 3. Notificaciones por nutricionista

```typescript
// Nutricionistas pueden enviar mensajes a sus pacientes
POST /api/push/nutritionist-message
{
  "patientId": "patient-id",
  "message": "Recuerda beber m√°s agua hoy",
  "type": "nutritionist-tip"
}
```

## üõ†Ô∏è Troubleshooting

### Problemas comunes

1. **"No compatible" en Safari/iOS**
   - **Requisitos**: iOS 16.4+ o macOS Safari 16+
   - **PWA Mode**: Debe estar instalada como PWA (modo standalone)
   - **Service Worker**: Debe estar funcionando correctamente
   - **HTTPS**: Obligatorio (localhost tambi√©n funciona)

2. **"No compatible" en otros navegadores**
   - Verifica que uses HTTPS o localhost
   - Aseg√∫rate de usar Chrome, Firefox, Safari o Edge
   - Revisa que el service worker est√© registrado

3. **Permisos bloqueados**
   - Click en el √≠cono de candado en la barra de direcciones
   - Cambia notificaciones a "Permitir"
   - Recarga la p√°gina

4. **Notificaciones no llegan**
   - Verifica en DevTools que la suscripci√≥n se cre√≥
   - Revisa los logs del service worker
   - Confirma que las claves VAPID son correctas

5. **Error de suscripci√≥n**
   - Verifica la conectividad de red
   - Aseg√∫rate de que Supabase est√© disponible
   - Revisa que la tabla `push_subscriptions` exista

### üçé Safari/iOS Espec√≠fico

#### Verificar Compatibilidad Safari

```javascript
// Ejecuta esto en DevTools Console de Safari
console.log('üîç Verificaci√≥n Safari Push Notifications:')
console.log('iOS Version:', navigator.userAgent)
console.log('Service Worker:', 'serviceWorker' in navigator)
console.log('Push Manager:', 'PushManager' in window)
console.log('Notifications:', 'Notification' in window)
console.log('Standalone Mode:', navigator.standalone || window.matchMedia('(display-mode: standalone)').matches)
console.log('Permission:', Notification.permission)

// Verificar Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.ready.then(reg => {
    console.log('SW Registration:', reg)
    console.log('Push Manager Available:', !!reg.pushManager)
  })
}
```

#### üÜò Script de Reparaci√≥n Safari Completo

**Ejecuta este script en DevTools Console de Safari para diagnosticar y reparar:**

```javascript
// üîß Script de Diagn√≥stico y Reparaci√≥n Safari
// Ejecuta esto en DevTools Console de Safari
async function safariDiagnosisAndRepair() {
  console.log('üçé Iniciando diagn√≥stico Safari Push Notifications...')
  
  const results = {
    environment: {
      userAgent: navigator.userAgent,
      isStandalone: navigator.standalone || window.matchMedia('(display-mode: standalone)').matches,
      protocol: window.location.protocol,
      url: window.location.href
    },
    support: {
      serviceWorker: 'serviceWorker' in navigator,
      pushManager: 'PushManager' in window,
      notifications: 'Notification' in window,
      permissions: Notification.permission
    },
    serviceWorker: {
      registrations: [],
      ready: false,
      error: null
    }
  }
  
  console.log('üìã Informaci√≥n del entorno:', results.environment)
  console.log('üîç Soporte de APIs:', results.support)
  
  // Paso 1: Verificar registraciones existentes
  try {
    const registrations = await navigator.serviceWorker.getRegistrations()
    results.serviceWorker.registrations = registrations
    console.log(`üìù Registraciones encontradas: ${registrations.length}`)
    
    registrations.forEach((reg, index) => {
      console.log(`  Registro ${index + 1}:`, {
        scope: reg.scope,
        active: !!reg.active,
        installing: !!reg.installing,
        waiting: !!reg.waiting
      })
    })
    
    // Paso 2: Si no hay registraciones, registrar manualmente
    if (registrations.length === 0) {
      console.log('üîÑ No hay registraciones, registrando service worker...')
      
      try {
        const registration = await navigator.serviceWorker.register('/sw.js')
        console.log('‚úÖ Service Worker registrado exitosamente:', registration)
        
        // Esperar a que est√© listo
        const readyRegistration = await navigator.serviceWorker.ready
        results.serviceWorker.ready = true
        results.serviceWorker.registration = readyRegistration
        
        console.log('‚úÖ Service Worker est√° listo:', readyRegistration)
        
        // Verificar PushManager
        if (readyRegistration.pushManager) {
          console.log('‚úÖ PushManager disponible en el service worker')
        } else {
          console.log('‚ùå PushManager NO disponible en el service worker')
        }
        
      } catch (regError) {
        console.error('‚ùå Error registrando service worker:', regError)
        results.serviceWorker.error = regError.message
      }
      
    } else {
      // Paso 3: Verificar si la registraci√≥n existente est√° lista
      try {
        const readyRegistration = await navigator.serviceWorker.ready
        results.serviceWorker.ready = true
        results.serviceWorker.registration = readyRegistration
        console.log('‚úÖ Service Worker existente est√° listo')
        
        if (readyRegistration.pushManager) {
          console.log('‚úÖ PushManager disponible')
        } else {
          console.log('‚ùå PushManager NO disponible')
        }
        
      } catch (readyError) {
        console.error('‚ùå Error con service worker existente:', readyError)
        results.serviceWorker.error = readyError.message
      }
    }
    
  } catch (error) {
    console.error('‚ùå Error general con service worker:', error)
    results.serviceWorker.error = error.message
  }
  
  // Paso 4: Prueba de notificaci√≥n local
  console.log('üîî Probando notificaci√≥n local...')
  if (Notification.permission === 'granted') {
    try {
      new Notification('Test Safari', {
        body: 'Si ves esto, las notificaciones funcionan',
        icon: '/icons/icon-192x192.png'
      })
      console.log('‚úÖ Notificaci√≥n local funciona')
    } catch (notifError) {
      console.error('‚ùå Error con notificaci√≥n local:', notifError)
    }
  } else {
    console.log('‚ö†Ô∏è Permisos de notificaci√≥n no otorgados:', Notification.permission)
  }
  
  // Paso 5: Resultado final
  console.log('üìä Diagn√≥stico completo:', results)
  
  const allWorking = results.support.serviceWorker && 
                     results.support.pushManager && 
                     results.support.notifications && 
                     results.serviceWorker.ready
  
  if (allWorking) {
    console.log('üéâ ¬°TODO FUNCIONA! Safari deber√≠a soportar push notifications.')
    console.log('üí° Recarga la p√°gina para que la app detecte los cambios.')
    
    // Auto-reload despu√©s de 2 segundos
    setTimeout(() => {
      console.log('üîÑ Recargando p√°gina...')
      window.location.reload()
    }, 2000)
    
  } else {
    console.log('‚ùå Hay problemas. Revisa los errores arriba.')
    
    const missing = []
    if (!results.support.serviceWorker) missing.push('Service Worker API')
    if (!results.support.pushManager) missing.push('Push Manager API')
    if (!results.support.notifications) missing.push('Notifications API')
    if (!results.serviceWorker.ready) missing.push('Service Worker no est√° listo')
    
    console.log('‚ùå Faltan:', missing.join(', '))
    
    // Sugerencias espec√≠ficas
    console.log('üí° Sugerencias:')
    if (!results.environment.isStandalone) {
      console.log('   1. Instala la app como PWA (Agregar a pantalla de inicio)')
    }
    if (results.environment.protocol !== 'https:' && !results.environment.url.includes('localhost')) {
      console.log('   2. Usa HTTPS (obligatorio para service workers)')
    }
    if (results.serviceWorker.error) {
      console.log(`   3. Error espec√≠fico: ${results.serviceWorker.error}`)
    }
    console.log('   4. Actualiza iOS/Safari a la versi√≥n m√°s reciente')
    console.log('   5. Cierra y reabre la app PWA')
  }
  
  return results
}

// Ejecutar el diagn√≥stico
safariDiagnosisAndRepair()
```

#### Pasos Manuales para Safari

Si el script autom√°tico no funciona, sigue estos pasos:

1. **Verificar versi√≥n de iOS/Safari:**
   ```javascript
   console.log('User Agent:', navigator.userAgent)
   // Debe ser iOS 16.4+ o Safari 16+
   ```

2. **Registrar service worker manualmente:**
   ```javascript
   navigator.serviceWorker.register('/sw.js')
     .then(reg => {
       console.log('SW Registrado:', reg)
       return navigator.serviceWorker.ready
     })
     .then(reg => {
       console.log('SW Listo:', reg)
       console.log('Push Manager:', !!reg.pushManager)
     })
     .catch(console.error)
   ```

3. **Verificar que el archivo sw.js sea accesible:**
   ```javascript
   fetch('/sw.js')
     .then(response => {
       console.log('SW File Status:', response.status)
       if (response.ok) {
         console.log('‚úÖ Service Worker file is accessible')
       } else {
         console.log('‚ùå Service Worker file not found')
       }
     })
     .catch(console.error)
   ```

4. **Limpiar registraciones corruptas:**
   ```javascript
   navigator.serviceWorker.getRegistrations()
     .then(registrations => {
       registrations.forEach(registration => {
         console.log('Unregistering:', registration.scope)
         registration.unregister()
       })
       console.log('All SW unregistered. Reload page to re-register.')
     })
   ```

## üîí Seguridad y mejores pr√°cticas

### Seguridad
- ‚úÖ Las suscripciones est√°n protegidas por RLS
- ‚úÖ Solo el usuario puede ver/editar sus suscripciones
- ‚úÖ Validaci√≥n de autenticaci√≥n en todas las APIs
- ‚úÖ Claves VAPID encriptadas en tr√°nsito

### Mejores pr√°cticas
- ‚úÖ Solicitar permisos en el momento apropiado
- ‚úÖ Explicar el valor de las notificaciones
- ‚úÖ Permitir desactivaci√≥n f√°cil
- ‚úÖ Respetar la frecuencia de env√≠o
- ‚úÖ Personalizar el contenido

### Rendimiento
- ‚úÖ Cach√© de estado de suscripci√≥n
- ‚úÖ Lazy loading del componente de configuraci√≥n
- ‚úÖ Optimizaci√≥n de payloads de notificaci√≥n
- ‚úÖ Limpieza autom√°tica de suscripciones inv√°lidas

## üìà Pr√≥ximas mejoras sugeridas

### Funcionalidades futuras

1. **Notificaciones inteligentes**
   - Recordatorios basados en horarios de comida
   - Sugerencias nutricionales personalizadas
   - Alertas de objetivos alcanzados

2. **Segmentaci√≥n avanzada**
   - Notificaciones por tipo de usuario (paciente/nutricionista)
   - Personalizaci√≥n por preferencias
   - Grupos de notificaci√≥n

3. **Analytics**
   - Tracking de apertura de notificaciones
   - M√©tricas de engagement
   - A/B testing de mensajes

4. **Integraci√≥n con calendario**
   - Recordatorios de citas con nutricionista
   - Notificaciones de seguimiento
   - Programaci√≥n personalizada

## üéâ Estado actual

### ‚úÖ Completado
- [x] Configuraci√≥n b√°sica de push notifications
- [x] Interface de usuario completa
- [x] APIs del backend funcionales
- [x] Service worker optimizado
- [x] Base de datos configurada
- [x] Sistema de permisos
- [x] Notificaciones de prueba
- [x] Manejo de errores
- [x] Documentaci√≥n completa

### üöß En desarrollo
- [ ] Variables de entorno para producci√≥n
- [ ] Notificaciones programadas
- [ ] Sistema de plantillas
- [ ] Analytics de notificaciones

### üîÆ Futuro
- [ ] Push notifications por geolocalizaci√≥n
- [ ] Integraci√≥n con wearables
- [ ] Notificaciones multimedia
- [ ] AI-powered recommendations

---

¬°Tu PWA de NutriGuide ahora tiene notificaciones push completamente funcionales! üéä

Los usuarios pueden activar las notificaciones desde la p√°gina de configuraciones y recibir recordatorios √∫tiles para mantener sus h√°bitos nutricionales. 